[[_TOC_]]

# AWS EC2

EC2(Elastic Compute Cloud)는 독립된 컴퓨터를 임대해주는 서비스입니다. 

본 수업의 하위 수업에서는 EC2의 개념과 사용방법을 알아봅니다. 

## EC2 소개

EC2 아마존 웹서비스의 대표적 상품.

AWS 콘솔로 들어가면 EC2 를 클릭. EC2의 지역을 선택.

EC2는 가장 먼저 생긴 서비스 중에 하나이고 가장 범용적인 서비스이면서 가장 관심있어 할만한 서비스임.

여러분에게 독립된 컴퓨터 한대를 통채로 임대해주는 상품임.

Instances = 컴퓨터 1대가 인스턴스 1대임. 

Launch Instance 버튼을 클릭하면 컴퓨터를 만들 수 있음. 그냥 클릭클릭클릭하면 컴퓨터가 금방 생성된다 라는 것만 느끼면됨.

단 1분만에 컴퓨터 1대가 만들어짐. 컴퓨터에 연격제어로 접속해서 컴퓨터가 마치 내 책상위 컴퓨터 처럼 원격으로 제어 가능.

조작하는 모습은 여러분의 상상에 맡기고 일단 생성하는 모습을 보여줌. 1분밖에 안걸렸다를 인상적으로 받아들여야됨.

더이상 컴퓨터가 필요없으면 오른쪽 클릭 Instance States - Terminate 를 클릭하면 컴퓨터가 삭제됨. 

## EC2 인스턴스 타입

Instances로 들어가야 인스턴스를 생성가능함. Launch Instance를 선택하면 인스턴스 생성 가능.

아마존 리눅스를 기본적으로 제공. 레드햇, 수세 리눅스, 우분투 제공. 이것들은 1년동안 무료로 사용가능한 제품들.

윈도우도 윈도우 서버 2012는 1년동안 무료로 사용할수 있음. 아마존 때문이 아니고 마소의 라이센스 정책 때문에..

우분투 선택

Choose an Instance Type (여러분의 임대 컴퓨터 사양을 선택.)

그중에 프리티어 선택. 나머지 컴퓨터는 컴퓨터를 키가마자 과금이 발생.

type = 각각의 컴퓨터의 사양. 가장 저렴하고 성능이 낮은건 nano

vCPUs(virtual CPU) = 몇개의 cpu가 달려있나.
Memory = 몇 기가의 메모리를 가지고 있나.
Network Performance = 네트워크 성능. (가격에 따라 차등이 있음)

AWS를 이용해서 여러가지를 하다보면 숫자에 대한 감각이 생김.

여러분이 하는 일에 따라 cpu가 강해야 되는 경우가 있고 메모리가 강해야되는 경우가 있음. 그것에 따라 상품이 구별되있음.

m으로 시작하는게 있고 c로 시작하는게 있음 (m은 메모리에 우위 c는 cpu에 우위) 자신의 환경에 따라 적합한 인스턴스 선택..

인스턴스 타입은 가격과 관련됨.

## EC2 가격정책

AWS EC2 Price 등으로 검색하면 가격정책을 수비게 볼 수 있음.(https://aws.amazon.com/ko/ec2/pricing/)

프리 티어

AWS의 프리 티어를 사용하는 신규 AWS 고객은 Amazon EC2를 무료로 시작할 수 있습니다. 신규 AWS 고객은 가입 시 1년 동안 매달 다음과 같은 EC2 서비스를 받게 됩니다.

* Linux, RHEL 또는 SLES를 구동하는 EC2 t2.micro 인스턴스 750시간 사용
* Microsoft Windows Server를 구동하는 EC2 t2.micro 인스턴스 750시간 사용
* Elastic Load Balancing 750시간 무료 사용 + 15GB의 데이터 처리 무료 제공
* 원하는 범용(SSD) 또는 마그네틱 조합으로 Amazon Elastic Block Storage 30GB + I/O 2백만 건(마그네틱) 및 스냅샷 스토리지 1GB
* 모든 AWS 서비스를 합산해 15GB의 데이터 전송
* 1GB의 리전 데이터 전송 무료 제공

**온디맨드 인스턴스**

여러분이 필요할때마다 컴퓨터를 키고 끌수 있는 인스턴스

리눅스냐 윈도우냐에 따라 가격차이 있음.

t2.micro 같은 경우 시간당 0.02달러 한국돈으로 20원? 게임방 생각하면 쌈. 하루에 480원정도? 한달에 14400원

잠깐 쓰면 가격경쟁력이 있음. 개발용이면 나노를 사용하게 되면 개발용으로는 충분할수 있음. 거의 7200원으로 쓸수있음.

제일 비싼 컴퓨터는 시간당 6700원  d2.8xlarge 컴퓨터 성능을 따지면 그렇게 비싼건 아님. (36코어 116메모리) 하루에 16만원

**예약 인스턴스**

켜고 끄거나 할때 경우에 따라 훨씬 저렴하게 사용할수있음 최대 75퍼 절약 할 수 있음.

**스팟 인스턴스**

아주 재미있고 특이한 인스턴스가 있음. 엄청난 컴퓨터를 아마존 웹 서비스가 보유하고 있음. (노는 컴퓨터가 항상 존재함)

노는 컴퓨터가 많으면 저렴. 노는 컴퓨터가 없으면 가격이 쎔

## EC2 인스턴스 장치설정

Number of instances = 생성하는 인스턴스 개수 1로 설정
Purchasing option Request Spot Instances 스팟 인스턴스를 하고 싶으면 체크(디폴트 체크 해제)
Shutdown behavior = stop (인스턴스일시정지), ternimate(인스턴스 삭제)
Monitoring = 체크시 돈이 부과된다.

Add Storage

EBS

Size 8 기본값 30기가 까지는 무료. 35기가 하면 유료

Volume Type : SSD가 훨씬 빠르겟죠? Magrtice보다

Delete on Termination 컴퓨터가 삭제되면 알아서 저장장치도 삭제됨. 체크해제하면 컴퓨터는 삭제되지만 하드는 삭제안됨. 기본값은 체크

## EC2 태그와 보안그룹

태그를 인스턴스에 붙이는 방법을 살펴볼 예정.

Tag Instance

Configure Security Group 

아주 중요한 부분. 일종의 방화벽 무료료 제공을 함.

이걸 하려면 지식이 필요함. 네트워크에 대해 조금 알아야됨. (오픈튜토리얼중에 인터넷 편을 들으면 됨 (ip, 도메인, port 등 설명))

우리가 만든 인스턴스에 접속하는 방식은 여러가지가 있을것. (원격접속, ftp, 웹서버 등) 모든 경우를 다 허용하는건 문을 여는거랑 다름 없기 때문에.

제한된 방법만을 통해 우리의 인스턴스로 접속하는 것을 허용하는 정책을 정하는 것. 리눅스의 경우 SSH는 기본 추가 되있음. (원격제어로 접속해야 되기 때문)

윈도우의경우 RDP가 지정되있음. (윈도우 원격접속은 RDP를 통해 제어하기 때문에)

## EC2 인스턴스 비밀번호 생성

인스턴스를 만드는 마지막 단계 까지옴.

서버 자원은 굉장히 소중해서. 복잡한 비밀번호를 써서 우리의 인스턴스를 공격으로 부터 방어하는 그러한 것임.

Create a new key pair로 비밀번호 발급 받을 수 있음 그리고 Download key Pair를 클릭하면 비밀번호를 다운받을 수 있음 그리고 우리의 인스턴스에 그 비밀번호를 심어놓음.

그래서 우리의 인스턴스를 접속하려면 그 비밀번호를 통해서 접속해야 됨. 공개키 비공개키.. 아마존에서 발급해주는 비밀번호는 엄청나게 긴 비밀번호이기 때문에. 안전함.

파일로 저장되있기 때문에 우리의 머리속에 있는 것보다는 위험함. (탈취될수있는 가능성이 한편으로 존재함) 양날의 검. 지금 다운 받은 파일을 굉장히 안전하고 소중하게 저장해야됨.

한번 파일을 다운받으면 다시는 비밀번호를 알려주지 않음. 그러면 여러분의 컴퓨터는 다시는 접속할 수 없는 상태가 됨. 아주 소중하게 다뤄야 됨.

## EC2 리눅스 인스턴스 접속

### OSX에서 리눅스 인스턴스로 접속

우리가 만든 가상머신에 원격제어를 하는 방법.

리눅스 원격제어 하는 방법을 살펴보고..

원격제어라는 것이 어떤 컴퓨터에서 다른 컴퓨터의 인터넷으로 접속해서 마치 자신의 컴퓨터인것처럼 제어하는 것.

그 과정에서 여러가지 문제가 생길 수 있음.

운영 체제 별로 원격제어하는 방법이 다름..

원격제어를 하려면 여러분이 설정한 인스턴스에서 오른쪽 클릭을 하면 Connect가 있는데 standalone ssh clinet 체크.

맥의 경우 ssh가 기본적으로 내장 되 있음.

터미널 실행.

예전에는 명령을 통해서 킴퓨터를 제어했음. 서버를 다룰때는 여전히 이 방식을 많이 씀.

별도의 디렉토리를 만들자. 프로그래밍을 하니 dev라는 디렉토리를 만들자. 파일은 비밀번호가 담긴 파일이라 다른 사람이 읽으면 절대 안됨. 그 파일을 400로 만들자. (400는 이 파일의 소유자만 파일을 읽을 수 있고 소유자가 아니면 이 파일이 존재하는지도 모르게 한다.) 터미널로 조정할수도 있고 파일에서 오른쪽 버튼 누르고 정보가져오기를 하고 공유 및 사용권환에서 설정할 수도 있다.

```
pwd : 현재 디렉토리 출력
ls -al : 현재 디렉토리에 있는 파일 목록
sudo chmod 400 aws_password.pem 
ssh -i "aws_password.pem" ubuntu@54.238.222.246
```

### Windows에서 리눅스 인스턴스로 접속

윈도우는 유닉스를 뿌리로 하는 운영체제와는 완전히 다른 운영체제임.

윈도우라는 운영체제에서 리눅스에 접속해서 원격제어를 하려고 하면.. 할 게 좀 있다. 뭘 설치를 해야됨.

윈도우에 SSH 역활을 해주는 프로그램을 직접 설치 해야됨. 원격제어 프로그램을 설치해야된다. 여러가지 프로그램이 있지만.. xshell 추천 (기업은 유료)

http://www.netsarang.co.kr/

좋네.. pem 바로 쓸 수 있음 (putty에서는 pem을 ppk로 변경해서 인식해야되는데.)

apache를 설치할 예정.

apache를 직접 설치하기에는 어려운 일임.. 그래서 우분투라는 운영체제에서 쉽게 설치할수 있는 기능이 있음.

sudo apt-get을 사용해서..

```
sudo apt-get update
sudo apt-get install apache2
```

설치하고 자신의 도메인 주소로 접속해서 화면이 뜨면 정상작동됨

자신의 도메인 주소는. AWS의 Public DNS임.


```
cd /var/www/html
sudo rm index.html
sudo nano index.html
```

[nano설명] (https://namu.wiki/w/nano)

## EC2 AWS Marketplace(Wordpress)

다른 사람의 인스턴스를 사용할 수 있다. 앱스토어를 생각 (앱스토어는 다른 사람이 만든 프로그램을 설치해서 사용하는 것)

아마존 웹 서비스에서 다른 사람이 만든 웹서비스를 쓴다는 것은 예를들어 워드프레스를 이용하면. 인스턴스를 만들고 필요한 소프트웨어(아파치, php, mysql 등) 그리고 워드프레스를 다운받고

설치하고, 보안관련 셋팅을 하고.. 등등 과정이 고되고 힘듬. 아무나 할수 있는게 아니고.. 이러한 경우에 이미 이 모든 과정을 끝낸 ami를 가지고 서비스를 하는 방법이 존재.

Instances로 들어가서 lanuch instance를 누르면 이미 각각의 운영체제도 이미 ami라고 해서 아마존에서 기본적으로 제공하는 이미지 였다..

여러분들이 자신이 만든 인스턴스를 이미지화 시킨것이 my amis 항목임. 다른 사람들이 만든 이미지를 가져다 쓰는 방법은 aws marketplace가 있음.

구글에서 검색. [aws marketplace](https://aws.amazon.com/marketplace) 여기서 원하는 서비스를 검색. ex) wordpress 

wordpress powered by bitnami(HVM)

중요하게 볼게 Pricing Details 임. 인스턴스 타입마다 가격이 다름. EC2 Usage 가격은 원래 ec2의 가격이고 softeware는 이 이미지를 제공한 이미지 생산자에게 지불해야되는 금액.

bitnami의 경우는 wordpress를 무료로 제공해서 아마존에게만 돈을 지급하면됨. 마치 앱스토어 처럼 이미지 스토어를 만든것임.

참고로 이걸로 워드프레스를 운영하는 입장이 아니라 혹시 놓치는게 있을 수 있음. 실제 서비스 시 훨씬 더 깊게 연구하고 테스트 해야됨

인스턴스가 생성되면 이메일이 오니 이메일에 중요한 정보들이 있으니 그걸 보고 여러가지 설정을 해주면 됨.

다른 사람이 만든 인스턴스를 너무나 쉽게 사용할 수 있음. 안전하고 쉽다. 상당히 편하고 안전하고 성능도 어느정도 보장할 수 있는 서비스를 빠른 속도로 만들 수 있음.

## EC2 Scalability - Scale Up

컴퓨터에 대한 수요는 시시각각 달라집니다. 

AWS EC2에는 이런 변화에 대응하기 위한 여러가기 기능을 가지고 있는데요. 

이번 시간에는 EC2 인스턴스의 규모를 유연하게 변경하는 방법을 알아봅니다.  

수업의 내용이 적지 않습니다. 꼼꼼하게 실습을 따라하는 것은 나중에 두번째 보실 때 하시고, 우선은 영상만 시청하면서 흐름을 파악하시는 것을 권하고 싶습니다.

1.5배속으로 보는 법 아시죠? 실습은 전체적인 맥락을 파악한 후에 하실 권합니다. 

scalability와 클라우딩 컴퓨팅의 관계.

ec2 인스턴스를 이용해서 우리가 여러대의 컴퓨터를 병렬로 연결하는. elb를 배우고.. 병렬로 연결될 컴퓨터를 자동의로 연결하고 삭제하는 (auto scaling)를 배우기 전 정리하는 과정.

지금까지는 실습 위주로 했지만. 이제는 이론적으로..

우선 우리가 살펴봤던 ec2의 가장 중요한 특징

* 가상화
* 종량제

ec2에 국한된게 아니고 클라우딩 컴퓨팅의 핵심적 아이디어.

가상머신이란? 가상 = 현실이 아니다 물리적인 컴퓨터가 아니고 물리적인 컴퓨터위에서 돌아가는 소프트웨어로 만든 거짓말 컴퓨터.

computer를 쓴다(물리적기계 필요) 

그 컴퓨터를 사용하기 위해서는 운영체제를 깔아야됨. 마소의 윈도우 맥의 osx 리눅스 등.. 운영체제가 하는 일 = 여러가지 소프트웨어 실행.

그렇게 설치된 소프트웨어는 운영체제를 통해서 기계를 제어함.

우리가 가상머신을 사용한다 하면. 운영체제에 프로그램을 하나 까는 것(여기서 생각하는 프로그램은 가상머신(소프트웨어로 만든 기계)) 자기가 정말 컴퓨터인 척 함 

하드웨어 적인 부분을 소프트웨어 적으로 만들었다. 이렇게 복잡한 일을 하는 이유?? 가상머신이 있기 때문에 가상머신을 여러개 만들어서 여러개의 운영체제를 설치할 수 있음

개인용 가상머신

* VMWare
* VirtualBox
* Parallels

지금 우리가 배우는 클라우딩 컴퓨팅은 개인용 시장을 겨냥한건 아님. 클라우딩 컴퓨팅의 가장 중요한 타겟은 기업이다. (대규모의 컴퓨팅 파워가 필요한.. 자원을 절약해야 하는..)

예를 들어 AWS의 회사는 많은 컴퓨터의 사용 요청이 있다. 그런것들이 가능하기 위해서 AWS같은 회사도 물리적 기계가 있어야됨. 여러분의 컴퓨터위에서 가상머신을 운영하기 위해서는 컴퓨터 한개가 있어야 되는것과 마찬가지

전세계의 컴퓨터를 만들어달라는 요청을 수용하기 위해서 아마존 같은 회사는 어마어마한 물리적 컴퓨터를 구비해놓음. 여러분이 AWS를 사용하는 입장이다.

두가지 경우

* 스타트업같은 경우 (사용자가 별로 없고, 개발하는거에 집중하고 싶은 경우)
* 거대한 기업이라 굉장한 컴퓨터가 필요한 경우

스타트업같은경우 나노 인스턴스 (저렴한 컴퓨터) 이렇게 후진 컴퓨터는 어디서 구할수도 없음. 이런 안좋은 컴퓨터가 필요한 이유? 싸니까.. 물리적 기계는 사이즈가 정해져있음.. 어떤 컴퓨터보다 성능이 안좋은 컴퓨터는 출시되지 않고

어떤 컴퓨터보다 성능이 좋은 컴퓨터는 출시되지 않음. 나노 컴퓨터로도 생각보다 많은 사용자를 수용할 수 있음. 

만약 여러분이 큰 회사고 강력한 컴퓨터가 필요하다. 그러면 x트라 라지 같은 인스턴스를 신청하면(강력한 컴퓨터) 그런 컴퓨터를 1분안에 만들어준다. 이게 가능한 이유? (물리적 컴퓨터를 여러개 묶어서 한대의 컴퓨터처럼 사용할 수 있게 함.)

저렴한 컴퓨터는 물리적 컴퓨터 한대를 여러개로 쪼개서 저렴한 컴퓨터 한대가 있는 것 같은 환상을 만들어줌.

우리가 클라우딩 컴퓨팅을 이용하는 것과 이용하지 않은 것의 차이??

**전통적인 모델**

물리적 컴퓨터는 가변적이지 않으므로 낭비되는 구간이 생길 수 밖에 없음

컴퓨팅 셋팅 시간도 오래 걸림.

최고점 까지 올라가서 만약 사용자의 수요가 떨어지면. 서비스의 품질은 매우 좋지만. 발생한 비용은 컴퓨터를 구매할때 사용한 비용. 네트워크 비용등.. 낭비됨. 팔려고 해도 잘 안팔림. 그만큼 손실

**클라우딩 컴퓨팅 모델**

수요와 공급을 맞출 수 있음 가변적으로. 낭비되는 공간 최소화.

빠르게 컴퓨터를 만들 수 있음. 그러다 사용자가 줄어든다?? 컴퓨터를 삭제하면 됨. 사용자가 는다? 컴퓨터를 산다..

비용 효율적이다. 그렇다고해서 클라우딩 컴퓨팅이 다 좋은 건 아니고.. 운영체제 위에 컴퓨터가 도는거라 퍼포먼스 적으로 패널티가 됨.

하지만 언제나 세상은 가변적이라.. 성능상으로 큰 이점이 있음.

### scalability - scalue up

scalability 은 두가지 전략이 있음.

* scale up
* scale out

컴퓨터를 사용하는데 있어서 컴퓨터에 대한 수요. 좀더 구체적으로 예를 들면.

여러분이 웹사이트를 운용하는데 웹사이트의 접속자가 늘어난다.. 줄어든다.. 수요가 변화하는데 그것에 대응하는 전략.. 

Scale up

컴퓨터 수요가 늘어나면 더 좋은 컴퓨터로 대체 하는것. 그래도 부족? 더 업그레이드. Scale up은 생각하기도 쉽고 실천하기도 쉽다.

컴퓨터가 느려지면 더 좋은 컴퓨터로 바꾸는 것임. 스케일 업 전략을 인스턴스에서 실행 할 예정. 그러기 위해서는 컴퓨터 2대가 필요함.

### 스트래스 테스트 준비

웹서버는 성능이 굉장히 좋아서 접속이 많아도 컴퓨터의 부하가 크게 차지 하지 않음. 

웹서버가 아니고 웹서버 위에 자바나 php나 파이썬이나 그런 언어들을 설치하면 하나 설치할때마다 속도가 확확 줄어듬. 무거워짐.

시연을 하기 위해서는 다소 무거운 웹 애플리케이션이 필요함. 워드프레스 정도의 규모가 있는 웹 애플리케이션이 빠르기가 힘듬.

공격(사용자의 접속) 수비(사용자가 접속할 서버) 컴퓨터를 만들 예정 수비는 워드프레스가 깔린 인스턴스임.

cpu 점유율 체크? 리눅스에서

```
top
```

접속을 하기 위해 준비한 공격 컴퓨터로 수비 컴퓨터에 접속한다.

접속을 하려고 광클을 하는건 힘든일이이고 눈하나 깜짝안함. 그러기 위해 필요한것이 사용자가 많이 접속하는걸 시뮬레이션 하는 소프트웨어를 설치할 것이다.

그때 사용해야될 명령어

```
sudo apt-get update
sudo apt-get install apache2-utils
```
아파치에서 만든 ab라는 부하 테스트하는 프로그램

### 스트래스 테스트 시작

워드프레스 인스턴스를 괴롭혀보자.

```
ab -n 400 -c 1 http://54.238.229.205/
ab -n 400 -c 2 http://54.238.229.205/
ab -n 400 -c 10 http://54.238.229.205/
ab -n 400 -c 20 http://54.238.229.205/
ab -n 400 -c 50 http://54.238.229.205/
ab -n 400 -c 100 http://54.238.229.205/
ab -n 400 -c 200 http://54.238.229.205/
```


|요청 | 동시접속 | 총소요시간|실패|초당처리속도|개별처리속도(초)|
|-----|---------|----------|----|-----------|--------|
|400  |   1     |  14.049  | 0  |  28.47    | 0.035|
|400  |   2     |  13.364  | 0  |  29.93    | 0.066|
|400  |  10     |  13.436  | 0  |  29.68    | 0.336|
|400  |  20     |  13.365  | 0  |  29.93    | 0.668|
|400  |  50     |  13.433  | 0  |  29.78    | 1.679| 
|400  | 100     |  13.465  | 0  |  29.71    | 3.366|
|400  | 200     |  13.420  | 0  |  29.81    | 6.709|

1초만 안넘으면 괜찮은 속도라고 봐도됨.

한번 사용자가 접속할때 6초가 걸린다?? 괜찮은 서비스가 아니다.. 이런 경우 Scale Up..


### Elastic IP

Elastic IP는 고정 아이피를 의미합니다. 스케일업을 하기에 앞서 고정 IP를 사용해서 컴퓨터를 교체해도 사용자는 동일한 IP를 통해서 서비스에 접근할 수 있도록 하는 방법을 알아봅니다. 

우리의 인스턴스를 이미지화 시키고 그 이미지화 한걸 더 좋은 인스턴스로 바꾸면 Scale Up임.

우리의 인스턴스를 스탑하고 재시작을 하면 기존에 있던 IP가 바뀜.. IP의 고갈현상과 굉장히 관련이 있음. IP 체계는 0.0.0.0 ~ 255.255.255.255 까지 가능함. 총 40억개의 ip가 존재할 수 있음

그 얘기는 이 세상의 컴퓨터 40억대 많이 주소를 가질 수 있음. 그 얘기는 아주 거칠게 표현하면 40억개의 컴퓨터많이 인터넷을 사용할 수 있다. 나머지는 마치 주소가 없는 무허가 집 같은 것임.

그런 집에는 우편같은걸 보낼 수 없다. 오늘날 컴퓨터는 40억대 이상이 됨. 그래서 아마존에서는 여러분이 컴퓨터를 안쓰면 ip를 회수해감 그리고 컴퓨터를 키면 다른 ip를 줌. 여러분이 쓰는 ip는 다른 사람한테 가는것임.

모든 사람이 컴퓨터를 항상 쓰는게 아니므로.. 킨사람한테 주고 끈사람한테 뺏는 돌려막기를 함. 컴퓨터를 이미지로 만들면.. (인스턴스를 그대로 복제하는) 이미지를 기반으로 더 좋은 컴퓨터를 만드는데..

예전에 썻던 ip로는 더이상 접속할 수 없는 상태가 됨.

이런 경우에 Elastic IP 이다. IP Address를 아마존으로 받아서 소유하는 것.

Elastic IPS - Allocate New Address를 하고 IP가 생성되고 아마존에게 받는 것 이것은 유료다..

엘라스틱 IP 주소 시간당 5원씩 비용이 발생. 월 3600원 정도?

잘 읽어보면 실행중인 인스턴스가 연결된 Elastic Ip는 무료임 (1개만)

탄력적 IP 주소

실행 중인 인스턴스에 연결된 탄력적 IP(EIP) 주소는 1개까지 무료로 사용할 수 있습니다. 해당 인스턴스에 추가 EIP를 연결하면 그에 비례하여 인스턴스와 연결된 추가 EIP별로 시간당 요금이 부과됩니다. 

추가 EIP는 Amazon VPC에서만 사용할 수 있습니다.

탄력적 IP 주소의 효율적인 사용을 보장하기 위해 IP 주소가 실행 중인 인스턴스와 연결되어 있지 않거나, 중지된 인스턴스 또는 분리된 네트워크 인터페이스와 연결되어 있는 경우 소액의 시간당 요금이 부과됩니다. 

* $0.00 실행 중인 인스턴스와 연결된 한 개 엘라스틱 IP 주소의 경우
* $0.005 실행 중인 인스턴스와 연결된 추가 엘라스틱 IP 주소당 시간에 비례하여
* $0.005 실행 중인 인스턴스와 연결되지 않은 엘라스틱 IP 주소당 시간에 비례하여
* $0.00 매달 처음 100개의 다시 매핑에 대한 엘라스틱 IP 주소 다시 매핑당
* $0.10 매달 100개 이후 추가 다시 매핑에 대한 엘라스틱 IP 주소 다시 매핑당

Elastic IP는 Release IP로 삭제 가능.

우리가 인스턴스를 하나 만들고 만든 인스턴스에 IP를 부여 하는 방법

Allocate New Address로 IP를 하나 만들고, 오른쪽 클릭 Associate Address를 클릭하면 인스턴스를 선택하라고 뜨고.. 

IP를 부여하고 싶은 인스턴스를 선택하고 Associate 버튼을 누르면 ip 가 할당됨

그러면 우리의 인스턴스에 Elastic IP를 갖게됨. 이상태에서 스탑했다 다시 켜도 이 인스턴스는 똑같은 IP를 가지고 있다.

### 인스턴스 교체

이미지 만들기.

인스턴스 오른쪽 Image - create Image

이미지를 만드는 도중에는 인스터스가 꺼진다. 그래서 바쁠때 하면 위험함. 

스케일업은 굉장히 위험한 작업을 할때는 이것저것 테스트 및 시나리오 작성등을 해서 신중하게 신중하게 하자..

amis로 가면 이미지가 만들어져있음. 

이미지를 이용해서 인스턴스를 만드릭 이전에 어떤 인스턴스 타입을 정하냐 설정해야됨.

인스턴스의 모니터링 탭을 보고 그것들에 적합한 인스턴스를 선택하자. 여러분들이 결정 해야됨.

amis에서 오른쪽 누르고 lanuch를 누르면 인스턴스를 선택할수 있다.

우리가 만든 인스턴스가 기존에 만든 인스턴스보다 성능이 좋은 인스턴스를 만들었는데 현재 만든 인스턴스에 접속하게 만들어야 됨. 그럼 어떻게 하냐? 기존에 만든 Elastic Ip를 해제하고 현재 만든 인스턴스에 할당해 준다. (사용자는 Elastic IP로 접속하기 때문에) 정말로 성능이 개선 되었을까???

마이크로 -> 라지로 변경
약 2배 이상 빠름.

|요청 | 동시접속 | 총소요시간|실패|초당처리속도|개별처리속도(초)|
|-----|---------|----------|----|-----------|--------|
|400  |   1     |  12      | 0  |  32.38    | 0.035  |
|400  | 200     |  6       | 0  |  61       | 3      |

가장 좋은 컴퓨터로 가면 됨.. 하지만 가장 좋은 컴퓨터로 가도 안되는 경우가 있음.. 그게 한계에 도달한거임. 스케일 업의 한계..
한계에 도달하면 스케일 아웃을 해줘야됨. 그런 작업들을 다음 수업에 공부할 거임. 될 수 있으면 스케일 업으로 처리 가능하면 스케일 업으로 하자. 스케일 아웃으로 가면 일종의 사회가 생김. 개인이 1개 있는 것과 1개이상이 될때 복잡함과 손실이 발생할 수 있음. 그런 문제가 산적해 있기 때문에 스케일 아웃은 적당한 규모가 됐을때 고민할 사항이지 처음 시스템을 할대 미래에 대한 대응을 한다고 복잡하게 처리한다고 좋은게 아니다. (너무 복잡해진다.) 지금 배운 스케일 업은 이해하기 쉽고 구성도 단순하니.. 일단은 스케일업을 통해서 적당한 적정 수준의 인프라를 구축하자. 스케일 업은 상당히 중요하고 이런 클라우드를 이용하면 여러분이 물리적인 기계를 스케일업 하는 것보다 훨씬 쉽게 할 수 있다.

## EC2 Scalability - Scale Out(ELB)

### Scale Out 소개 

이전에 살펴본 것은 스케일 업. 스케일 업은 컴퓨팅의 수요에 따라 더 좋은 컴퓨터로 업그레이드 하는 것.

이번 시간에 살펴볼 것은 스케일 아웃. 스케일 아웃은 여러대의 컴퓨터가 협력하여 동일한 목표를 달성하는 컴퓨터의 사회를 만드는 것.

판도라고 하는 숲은 스케일 아웃의 예. (나무는 여러갠데 뿌리가 하나임) 8만년 살았다. 무게는 엄청나게 무겁고 거대한 숲임.

시스템이 컴퓨팅 파워를 요구할 수록 점점 스케일 업을 할때.

어느 순간에 한계에 도달하게 됨. 그 한계를 뛰어넘을 수 있는 방법은 스케일 아웃 밖에 없다.

스케일 아웃을 들어가기 앞서서 여러분이 가장 먼저 고려할 것은 스케일 업이다. 처음부터 꿈이 커서 스케일 아웃에 너무 집착하면 나중에 후회할 가능성이 있다. 스케일 아웃은 굉장히 복잡하고 여러가지 문제를 낳을 수 있다. 될 수 있도록 간단한 해결책이 있으면 간단한 해결책을 쓰자.

시골길에 도로는 필요한 게 없다. 규모가 작아서

도시의 사거리는 신호등등의 복잡한 체계가 있다. 규모가 커서

규모에 따라 적합한 모델이 존재 함.

### Scale out의 흐름

여러분이 웹 애플리케이션을 만든다는 가정에 따라 어떻게 스케일 아웃을 하냐??

웹애플리케이션에 최적화된 얘기이긴 하지만 다른 경우에도 알아서 응용을 할 수 있다.

크게는 3가지 소프트웨어가 설치 되있을것

* Web Server(ngix, apache)
* Middle ware(php, jsp)
* Database(mysql, oracle)
 
특정한 기술에 종속된 얘기는 아니므로 자신의 환경에 맞게 적용.

사용자가 늘어나면 우리의 컴퓨터는 느려짐.

첫번째는 스케일 업. (하기도 쉽고 이해하기도 쉽고 유지보수도 쉽고)

스케일 업으로는 해결 안될때??? 스케일 아웃!!!

스케일 아웃은 뭔가 쫓아낸다는 느낌..

새로운 컴퓨터를 장만해서..

컴퓨터1은 (WebServer, Middleware)
컴퓨터2은 (Database)

미들웨어는 컴퓨터2의 DB에 접속하는 방식으로..

사용자의 입장에서는 바뀐게 없지만 내부적인 구성은 완전히 바뀜.

두대의 컴퓨터가 협동해서 일을 함. 

미들웨어와 데이터베이스 사이에는 서로 통신을 해야되는 장벽이 있기 때문에 성능상의 실질적인 저하가 있을 수 있지만 두대의 컴퓨터가 얻을수 있는 성능상의 이점이 크기 때문에 스케일 아웃을 함.

이러다가도 속도가 느려질 수 도 있다.

그럼 컴퓨터 1대를 더 장만.

* 컴퓨터1(WebServer)
* 컴퓨터2(Database)
* 컴퓨터3(Middleware)

3대의 컴퓨터로 일을 함.

이러다가 더 느려질 수 있음. 

새로운 컴퓨터를 장만하고 거기에 데이터베이스 설치.

* 컴퓨터1(WebServer)
* 컴퓨터2(Database Master)
* 컴퓨터3(Middleware)
* 컴퓨터4(Database Slave) Database Master의 내용 복제

미들웨어에서 읽기는 Database Slave 쓰기는 Database Master에서.

이 상황에서도 컴퓨터가 느리다?? 그럼 컴퓨터를 한대 더 장만


* 컴퓨터1(WebServer)
* 컴퓨터2(Database Master)
* 컴퓨터3(Middleware)
* 컴퓨터4(Database Slave1) Database Master의 내용 복제
* 컴퓨터5(Database Slave2) Database Master의 내용 복제

그래도 느려진다?

소위 샤딩이라 하는..

* 컴퓨터1(WebServer)
* 컴퓨터2(Database Master1) 1~1000번 사용자
* 컴퓨터3(Middleware)
* 컴퓨터4(Database Slave1) Database Master의 내용 복제
* 컴퓨터5(Database Slave2) Database Master의 내용 복제
* 컴퓨터6(Database Master2) 2000~3000번 사용자

이렇게 복잡해짐.

데이터베이스는 이런 방식으로 늘릴 수 있게 됬음.

하지만 미들웨어 쪽에서 컴퓨터가 느려진다??? 데이터베이스는 신경 안써도 되는데... 

마찬가지로 똑같은 방법으로 새로운 컴퓨터를 장만하고 그쪽으로 미들웨어를 설치한다.

* 컴퓨터1(WebServer)
* 컴퓨터2(Database Master1) 1~1000번 사용자
* 컴퓨터3(Middleware)
* 컴퓨터4(Database Slave1) Database Master의 내용 복제
* 컴퓨터5(Database Slave2) Database Master의 내용 복제
* 컴퓨터6(Database Master2) 2000~3000번 사용자
* 컴퓨터7(Middleware)

웹서버가 한번은 컴퓨터3에 한번은 컴퓨터7에 나눠서 작업해줌.

사용자가 어떤 사이트를 접속할때? 도메인을 입력해 접속함.

도메인을 입력하고 엔터를 치면 실제로 컴퓨터는 도메인에 해당하는 아이피를 알아내서 그 아이피에 해당되는 컴퓨터를 찾아내는 것.

사용자는 어떻게 그 도메인에 해당되는 아이피를 알아낼 수 있을 것인가?? 

DNS 서버에 접속해서 그 DNS에 저장되있는 도메인에 해당되는 IP를 알아내서 접속함. (일종의 전화번호부 같은 역활)

DNS서버라는 것이 어떤 도메인의 아이피는 뭐고 어떤 도메인의 아이피는 뭐다 라는 사실을 이미 알고 있기 때문에...

한대의 웹서버를 통해서 서비스하는 상황을 벗어나려면.

여기있는 DNS서버의 설정을 바꿔. 여러명의 사용자가 있으면 여러명의 사용자들이 서로 다른 아이피의 웹서버로 접속할 수 있다.

결과적으로는 부하를 분산할 수 있음. 이 방법이 있고..

다른 방법은 Load Balancer 라는 장치가 있음. 부하의 균형을 잡아줘서 부하가 골고루 분산되게 할 수 있는 장치.

이제 우리의 서비스는 Load Balancer이 IP를 가지고 있음.

사용자의 접속을 분산해주는 역활만 함. 이러한 로드밸런서를 

사용하면 죽은 컴퓨터에는 더이상 사용자를 보내지 않음.

또는 컴퓨터의 성능이 같은데 한 컴퓨터의 성능이 월등히 좋으면 그 
컴퓨터로 사용자를 보냄. ELB (Elastic Load Balancer)를 사용해서 부하를 분산하는 방법을 살펴볼 것임.

### ELB 생성

http://pyrasis.com/book/TheArtOfAmazonWebServices/Chapter18

부하를 적절히 분배하는 장치.

여러분이 이러한 장치를 구매하려면 굉장히 고가.

그리고 직접 구축하려면 상당한 노력이 필요.

하지만 AWS 에서는 클릭 몇번만으로 구현 가능함. 이러한 서비스는 여러분이 신경쓸 필요가 없음 AWS에서 알아서 관리해주기 때문에.

로드밸런서를 만들어보고 이 로드 밸런스에 우리가 만든 인스턴스를 붙여보자.

로드밸린서..

Health Check = 정기적으로 사용자의 서버가 죽었는지 안죽었는지 체크

일단은 만들고 DNS Name으로 접속하면 ELB로 접속할 수 있다.

### ELB 적용

로드밸런스를 만들었는데 일단 그 로드밸런스는 비어있음.

인스턴스를 만들고 웹서버를 설치할 거고 하나의 인스턴스를 더 만들어서 부하 발생기를 만들것.

* 웹서버
* 부하발생기

웹서버 Apache, PHP 설치
```
sudo apt-get update;
sudo apt-get install apache2;
sudo apt-get install php5;
```

부하발생기에는 
```
sudo apt-get update;
sudo apt-get install apache2-utils
```

부하발생기에서 웹서버로 엄청난 트래픽을 보내서 힘들게 만들것.

웹서버만 설치하면 안힘들어짐. 그래서 php를 설치할 예정. 간단한 코딩을해서 일부러 헛일을 하게 만들것임.

이제 우리가 php 애플리케이션을 하나 만들거고..

index.php 생성
```
cd /var/www/html
sudo nano index.php
```

index.php 내용
```
Hello AWS
<?php
for($i=0; $i<10000000; $i++){
 
}
?>
```

웹서버는 굉장히 가벼우니 일부러 php를 깔고 헛일을 하도록 코딩을 한것.

여러분이 웹서버의 주소로 접속하면 빈 공백이 나오면 된거임. 부하발생기를 이용해서 웹서버에 접속할것임.

```
ab -n 100 -c 1 http://54.238.246.130/index.php
ab -n 1000 -c 10 http://54.238.246.130/index.php
ab -n 1000 -c 50 http://54.238.246.130/index.php
```

접속이 시작됨. top 명령어를 통해서 우리의 컴퓨터의 상태를 볼 수 있음.

부하가 얼마나 발생하는지 보여주고 있음. 이러한 상황에서 우리의 ELB 가 출동하면 어떨까?

일단 ELB를 사용하려면 웹서버가 한개면 의미가 없음 한개를 더 만든다.

기존의 웹서버 인스턴스를 이미지로 만듬. create Image를 만들고 AMIS를 이용해 인스턴스를 만든다.

이렇게 만든 인스턴스가 웹서버와 완전히 동일한 인스턴스다. ELB의 인스턴스 탭을 누르고 

우리가 만든 인스턴스 2개를 선택하고 확인을 누름 그러면 우리가 만든 인스턴스가 ELB에 붙는거임.

ELB로 접속하는 방법 = DNS Name임. DNS Name으로 접속하면 됨. 사용자들이 접속하면 이 ELB에 접속하게 되는 거고

이 ELB가 각각의 웹서버로 접속함.

웹서버에서 사용자가 접속하는지 로그를 볼수 있음

```
sudo tail -f /var/log/apache2/access.log
```

접속을 하면 로딩할때마다 로그에 변화가 생김.

ELB를 이용하면 두개의 웹서버가 서로 주거나 받거나 함 (완벽한 부하분산이 되나 보네.)

```
ab -n 100 -c 1 ELB주소
ab -n 1000 -c 10 ELB주소
ab -n 1000 -c 50 ELB주소
```

ELB는 얼마나 많은 사용자를 버틸까? 아마존 닷컴도 ELB를 사용함. ELB에서 문제가 생긴적은 없다고 하니까 신결 쓸 필요 없다.

물론 우리가 사용하는 ELB는 주소가 이상하니 도메인을 구입해서 그 도메인을 ELB에 붙이면 됨. 컴퓨터가 부족할때마다 우리가 수동으로 

ELB를 붙이는건 쉽지 않음. 사용자가 쇄도하는 순간 클라이막스인데 그 순간을 놓치는게 너무 안타깝다..

그래서 방금 우리가 한 수동 작업을 완전히 자동화 하는것이 오토 스케일링이다. 자동으로 규모를 조정해준다 라는 뜻.

오토 스케일링과 만나면 ELB는 훨씬 강력해진다.

### ELB 사용시 주의 사항

ELB를 사용할 때 조심해야 되는 것.

두대의 인스턴스름 만들고 각각의 인스턴스를 ELB로 연결을 한다.

인스턴스에 (Webserver, MiddleWare, Database가 설치 되있음)

컴퓨터1로 들어온 데이터는 웹서버를 거쳐서 데이터베이스에 저장됨.

컴퓨터2로 들어온 데이터는 웹서버를 거쳐서 데이터베이스에 저장됨.

데이터베이스가 포함된 인스턴스는 이렇게 스케일 아웃 하면 안됨. (컴퓨터1과 컴퓨터2는 다른 DB) 

우리가 살펴본 것은 웹서버가 있고 데이터베이스가 없는 인스턴스를 대상으로 해서 ELB 수업을 했음.

이렇게 스케일 아웃을 했다가는 사용자에 따라 다른 화면을 보여야 되는 낭패를 보게 될것이다. 이것을 이해하고 잘 해야 된다.

그럼 어떻게 스케일 아웃을 하냐??? 

* 컴퓨터 1 (WebSever, Middleware)
* 컴퓨터 2 (WebSever, Middleware)
* 컴퓨터 3 (Database)

이렇게해야된다. 그렇기 때문에 ELB가 어느쪽으 컴퓨터로 사용자를 안내해도 동일한 DB를 사용하기 때문에 문제가 생기지 않는다.

이것이 ELB를 사용하는데 정말 조심해야 된다.

## EC2 Scalability - Auto Scaling

### Amazon EC2 AutoScaling 소개

여러개의 인스턴스가 힘을 합쳐 사용자가 만든 트래픽을 감당하는 것을 이전 시간에 살펴봄.

사용자가 언제 쇄도 하는지 알 수 없고.. 우리는 우리의 생활이 있기 때문에.. 우리가 수동으로 하는 작업을 기계가 하도록 하는 일종의 인공지능 같은 서비스가 AutoScaling이다.

AutoScaling가 아마존 웹 서비스의 꽃중에 하나다. 컴퓨터가 필요하면 컴퓨터 자동 실행 컴퓨터가 필요없으면 자동 삭제. 

요러한 탄력성이 클라우딩 컴퓨터가 주는 중요한 장점이다.

첫번째로 부하발생기를 설치한 인스턴스를 준비.

AMI로 가서 우리가 웹서버를 ELB에 붙이기 위한 이미지가 있는지 확인 (없으면 생성) 

우리가 ELB를 인스턴스에 붙일때 인스턴스를 이미지화 해서 붙였고. 오토스케일링도 마찬가지임.

Launch Configurations = 인스턴스를 생성. (이미지를 실제 동작하는 인스턴스로 만드는 행위를 설정)

Auto Scaling Groups

우선 Launch Configurations으로 가서 Create Auto Scaling Group 선택

Create launch configuration 버튼 클릭 -> 인스턴스를 만드는 화면이 뜸.

오토스케일링을 하기 위해서는 오토스케일링에 사용될 이미지를 선택하는게 첫번째 일이다.

MY AMIs라는게 있음. (여러분이 생성한 이미지들) 우리가 오토스케일링할 이미지를 선택 하고 넥스트

인스턴스의 성능을 지정하는 화면에서 성능을 선택하고 넥스트.

그리고 이름 설정하고 넥스트.. 스토리지 선택하고 넥스트. 시큐어티 그룹 설정하고 넥스트. 생성.

### Amazon EC2 AutoScaling(Launch Configuration) 생성

이전시간에 Launch Configurations을 만듬.

1. 자동으로 인스턴스를 만든다고 하면 그 인스턴스는 어떤 이미지에 기반하는가? 어떤 인스턴스 타입을 사용하는가? 컴퓨터의 성능 형태를 정의(Launch Configurations)
2. 그렇게 정의한 컴퓨터를 언제 어떤 조건에서 만들것이냐? (Auto Scaling Groups)

오토스케일링을 통해서 언제라는것을 정의

컴퓨터 프로그래밍의로 치면 이벤트

그룹 네임이라는 부분에 우리의 오토스케일링의 이름을 정함. 그룹 사이즈 = 우리가 오토스케일링을 만들때 몇개의 인스턴스로 시작할것이냐?

서브넷 = 그냥 클릭해서 선택 하면됨. 가용구역? 오토스케일링이 인스턴스를 생성할때 가용구역에서 번갈아가면서 인스턴스를 만듬

Advanced Details 

우리가 오토스케일링을 적용해 인스턴스를 만들면 그렇게 만든 인스턴스를 어떤 특정한 로드밸런서에 알아서 붙일 수 있음.

넥스트 클릭후 다음 

Keep this group at its initail group 초기의 지정해 둔 사이즈를 유지한다.

Use scaling pollicies to adjust the capacity of this group 컴퓨터의 필요에 따라 늘리고 줄이고 하는 부분

### AutoScaling 생성 2

Use scaling pollicies to adjust the capacity of this group 컴퓨터의 필요에 따라 늘리고 줄이고 하는 부분

오토스케일링이라고 하는 것을 어떤 관점으로 보는 거에 따라 전혀 다르게 봄.

하한과 상한을 정할 수 있음. 

Increate Group Size

오토 스케일링이 동작할때 어떨때에 증가할것이냐 감소할 것이냐를 지정 할 수 있음.

Execute pollicy when에 오토스케일링을 통해서 만드는 인스턴스를 AWS 에서 감시. 그 감시를 하는 과정에서 인스턴스들이 어떤 특정한 상태에

도달했을때 알람이 오토스케일링에게 전달됨. CPU Utilization (CPU 점유율)

Take the action 경고가 울릴때 실행하는 것. 

Decreate Group Size 

인스턴스를 삭제하는 조건. 위와 마찬가지로 설정 할 수 있음 

그다음에 Next 하고

notification설정을 할 수 있음 (오토스케일링 될때 통보받을 수단 선택 가능)

넥스트 넥스트 해서 만들 수 있음

우리가 ELB에게 트래픽을 줘서 스트래스를 주면 CPU 점유율이 일정 수준 이상이되면 오토스케일링이 동작되서 순차적으로 인스턴스가

생성될것임. 그리고 트래픽이 줄어들면 인스턴스는 자동으로 삭제 될것.

### AutoScaling 테스트

정말로 오토스케일링이 자동으로 인스턴스를 생성하는지 확인

통보기능을 켜놨는데 통보기능을 사용하기 위해서는 이메일로 들어가서 이메일을 승인해야됨.

우리가 ELB로 신호를 보낼건데. 서비시스로 들어가면 매니지먼트 툴에 클라우드 와치가 있음

클라우드 와치는 AWS에서 제공하는 여러가지 서비스를 관재할 수 있는 기능임

알람이 누구냐에 따라 컴퓨터가 꺼지기도 하고 켜지기도 함.

```
ab -n 1000000 -c 3 ELB주소
```

이런느낌으로 하면 CPU 점유율이 거의 98퍼 정도를 유지함.

우리가 설정한 상태는 이 상태가 5분이상 지속되면 인스턴스 2개가 생성될거임

시간이 지나니.. 인스턴스가 알아서 생성되고 알람도 울림.

인스턴스 현재 정말로 만들어진 인스턴스

Desired = 오토스케일링이 지금 필요한 인스턴스

인스턴스를 보면 3개의 인스턴스가 만들어져있음. 로드밸런서에도 인스턴스가 3개가 붙음.

인스턴스를 그만 괴롭히면 cpu 점유율이 0 이되면서 오토스케일링으로 인해 사용자 입장에서는 시스템이 느려졌다 빨라지는 경험을 했을 것이다.

부하를 종료하고 조금 더 기다리면 알람이 바뀜 30퍼 이하의 알람이 켜짐. 오토스케일링에서는 자동으로 인스턴스를 삭제해줌.

결과적으로는 돈이 절약됨. (엄청 쉽게 부하분산이 가능한 구조네..)

한가지 주의해서 알아야 되는것은 어떤 인스턴스가 삭제될지는 알수 없고 오토스케일링에 의해 자동으로 생성되므로

여러분들은 인스턴스를 쓰고 버린다고 생각해야됨. 클라우딩 컴퓨팅은 이런 오토스케일링이 빈번하게 일어나므로

이미지가 중요하다(AMI) 이미지를 기반으로 필요에 따라 언제든지 인스턴스를 만들어서 삭제 버린다라는 느낌임.

클라우팅 컴퓨팅에서 인스턴스는 달면 삼키고 쓰면 뱉는.. 계약직 관계 소모품과 같은 것임.

그에 따라 시스템에 설계도 달라져야 된다. 완전히.. 

우리는 그냥 간단한 애플리케이션 살펴봤지만.. 뒤에 나오는 다른 기술들과 접목하면서 이를 좀더 복잡하게 하는 방법을 살펴볼 예정이다.

다 작업이 끝났으면 여러분이 쓰던것들을 정리 해야됨. 오토스케일 그룹을 딜리트 하면 여러분이 만든 인스턴스가 삭제될 것이고

클라우드 와치에서 오토스케일링에서 만든 알람도 삭제. 이렇게 정리를 안하면 나중에 요금 폭탄을 맞음

SNS에서 Topics로 가면 이것도 삭제 Subscriptos도 뭐가 있으면 지워버리자.